<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>52108 å•†å“ç›‘å¬ & ä»·å€¼ç­›é€‰åˆé›†</title>
  <style>    
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .card { 
      background: white; 
      padding: 24px; 
      border-radius: 16px; 
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12); 
    }
    h1 { 
      text-align: center; 
      margin: 0 0 24px 0;
      color: #333;
      font-size: 24px;
      font-weight: 600;
    }
    h2 { 
      margin: 0 0 16px 0; 
      font-size: 18px; 
      font-weight: 600;
      color: #333;
      padding-bottom: 8px; 
      border-bottom: 2px solid #ff6a00; 
    }
    label { 
      display: block; 
      margin-top: 12px; 
      margin-bottom: 6px;
      font-weight: 500; 
      color: #555;
      font-size: 14px;
    }
    input, select { 
      width: 100%; 
      padding: 10px 12px; 
      border-radius: 8px; 
      border: 1px solid #ddd; 
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ff6a00;
      box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.1);
    }
    button { 
      padding: 10px 20px; 
      border-radius: 8px; 
      border: none; 
      font-size: 14px; 
      font-weight: 500;
      cursor: pointer; 
      transition: all 0.2s;
    }
    button:hover { 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      transform: none;
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-primary { background: #ff6a00; color: white; }
    .btn-primary:hover { background: #e55a00; }
    .btn-stop { background: #6c757d; color: white; }
    .btn-stop:hover { background: #5a6268; }
    .btn-save { background: #28a745; color: white; }
    .btn-save:hover { background: #218838; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-row { 
      display: flex; 
      gap: 10px; 
      margin-top: 16px;
    }
    .btn-row button {
      flex: 1;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .checkbox-group { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
      gap: 8px; 
      margin-top: 8px; 
    }
    .checkbox-group label, .checkbox-row label { 
      font-weight: normal; 
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkbox-group label:hover, .checkbox-row label:hover {
      background: #f5f5f5;
    }
    .checkbox-group input[type="checkbox"], .checkbox-row input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }
    .checkbox-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .hidden { display: none; }
    a { color: #4da3ff; text-decoration: underline; }
    .status-bar { 
      padding: 12px 16px; 
      border-radius: 8px; 
      font-size: 14px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .status-bar.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .status-bar.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .status-bar.warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .status-bar.processing { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    .log { 
      background: #1e1e1e; 
      color: #0f0; 
      padding: 16px; 
      height: 300px; 
      overflow: auto; 
      font-size: 12px; 
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    .log::-webkit-scrollbar { width: 8px; }
    .log::-webkit-scrollbar-track { background: #2a2a2a; }
    .log::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    .log::-webkit-scrollbar-thumb:hover { background: #777; }

    /* å®šæ—¶ä»»åŠ¡åˆ—è¡¨æ ·å¼ (ä¸»é¡µç‰¹æœ‰) */
    .task-list { margin-top: 12px; }
    .task-item { 
      background: #f8f9fa; 
      padding: 16px; 
      margin-bottom: 12px; 
      border-radius: 8px; 
      border-left: 4px solid #ff6a00; 
      position: relative;
      transition: box-shadow 0.2s;
    }
    .task-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .task-item.pending { border-left-color: #2196F3; }
    .task-item.processing { border-left-color: #ff9800; background: #fff8e1; }
    .task-item.success { border-left-color: #4CAF50; background: #e8f5e9; }
    .task-item.expired { border-left-color: #999; background: #f5f5f5; opacity: 0.7; }
    .task-item.error { border-left-color: #f44336; background: #ffebee; }
    .task-info { font-size: 13px; line-height: 1.8; }
    .task-info strong { color: #333; font-size: 14px; }
    .task-status { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 4px; 
      font-size: 11px; 
      margin-left: 8px; 
      font-weight: 500;
    }
    .task-status.pending { background: #e3f2fd; color: #1976d2; }
    .task-status.processing { background: #ffe0b2; color: #e65100; }
    .task-status.success { background: #c8e6c9; color: #388e3c; }
    .task-status.expired { background: #e0e0e0; color: #757575; }
    .task-status.error { background: #ffcdd2; color: #c62828; }
    .task-delete { 
      position: absolute; 
      top: 12px; 
      right: 12px; 
      background: #dc3545; 
      color: white; 
      border: none; 
      padding: 6px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 12px;
      font-weight: 500;
    }
    .task-delete:hover { background: #c82333; opacity: 1; }
    .task-countdown { color: #ff6a00; font-weight: bold; }
    .no-tasks { text-align: center; color: #999; padding: 40px 20px; font-size: 14px; }

    /* ä»»åŠ¡è®¾ç½®åŒºåŸŸæ ·å¼ */
    .task-settings {
      margin-top: 12px;
      padding: 12px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .task-settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .task-setting-item {
      display: flex;
      flex-direction: column;
    }
    .task-setting-item label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #666;
    }
    .task-setting-item input {
      padding: 6px 8px;
      font-size: 13px;
    }
    .task-setting-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 6px;
      font-weight: 500;
    }

    /* å‘½ä¸­å•†å“åˆ—è¡¨ (é€šç”¨) */
    .matched-goods-list { margin-top: 8px; max-height: 400px; overflow-y: auto; }
    .matched-goods-list::-webkit-scrollbar { width: 8px; }
    .matched-goods-list::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 4px; }
    .matched-goods-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .matched-item {
      display: flex; align-items: center; flex-wrap: wrap; gap: 8px;
      padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px;
      border-left: 4px solid #28a745; font-size: 13px;
    }
    .matched-item .matched-name { font-weight: 600; color: #333; min-width: 100px; }
    .matched-item .matched-meta { color: #666; }
    .matched-item a { color: #4da3ff; text-decoration: underline; }
    .matched-item a:hover { text-decoration: none; }
    .no-matched { text-align: center; color: #999; padding: 24px; font-size: 14px; }

    /* æ‰«ä»·å€¼ç‰¹æœ‰æ ·å¼ */
    .matched-item .worth-earn {
      font-size: 18px; font-weight: 700; color: #28a745; margin-right: 12px;
      flex-basis: 100%; margin-bottom: 4px;
    }
    .formula-options { margin-top: 8px; }
    .formula-option {
      display: grid; grid-template-columns: auto 1fr; gap: 12px 16px;
      align-items: start; margin-bottom: 12px; padding: 12px 14px;
      border-radius: 8px; background: #f8f9fa;
    }
    .formula-option input[type="radio"] { margin: 3px 0 0 0; cursor: pointer; }
    .formula-desc { font-size: 14px; line-height: 1.7; color: #333; }
    .formula-desc strong { display: inline-block; margin-right: 6px; }
    .formula-desc .line { display: block; margin-top: 2px; }
    .formula-threshold { margin-top: 12px; }
    .formula-threshold label { margin-bottom: 4px; }
    .formula-threshold input { max-width: 120px; }

    /* Tab æ ·å¼ */
    .tab-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px;
      border-radius: 12px;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
    }
    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      opacity: 1;
    }
    .tab-btn.active {
      background: white;
      color: #ff6a00;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .btn-row { flex-direction: column; }
      .checkbox-group { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="card" style="text-align: center; padding: 20px;">
      <h1 style="margin: 0;">ğŸ› ï¸ 52108 å·¥å…·ç®±</h1>
    </div>

    <!-- Tab å¯¼èˆª -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('home')">ğŸ® å®šæ—¶ä¸‹å• & ç›‘å¬</button>
      <button class="tab-btn" onclick="switchTab('scan')">ğŸ’ ä»·å€¼å•†å“ç­›é€‰</button>
    </div>

    <!-- Tab å†…å®¹: ä¸»é¡µ (å®šæ—¶ä¸‹å• & ç›‘å¬) -->
    <div id="tab-home">
      <!-- åŸä¸»é¡µå†…å®¹ -->
      <div class="card">
        <h1>ğŸ® 52108å•†å“ç›‘å¬ V3.2ï¼ˆç­›é€‰+å®šæ—¶ä¸‹å•ï¼‰</h1>
        <div id="statusBar" class="status-bar hidden"></div>
      </div>

      <div class="card">
        <h2>ğŸ“‹ åŸºç¡€ç­›é€‰è®¾ç½®</h2>
        <div class="form-group">
          <label>å•†å“ç±»å‹</label>
          <select id="type" onchange="onTypeChange()">
            <option value="99">è§’è‰²</option>
            <option value="1">è£…å¤‡</option>
            <option value="2">æ¶ˆè€—å“</option>
            <option value="3">æœ‰é™å“</option>
            <option value="4">ææ–™</option>
            <option value="5">æ‚è´§</option>
            <option value="6">æ‰“æ†é“å…·</option>
          </select>
        </div>

        <div id="jobBox" class="form-group">
          <label>èŒä¸šç­›é€‰</label>
          <div class="checkbox-group">
            <label><input type="checkbox" class="job-checkbox" value="1"> æˆ˜å£«</label>
            <label><input type="checkbox" class="job-checkbox" value="2"> æ³•å¸ˆ</label>
            <label><input type="checkbox" class="job-checkbox" value="3"> æœ¯å£«</label>
          </div>
        </div>

        <div id="equipBox" class="form-group hidden">
          <label>è£…å¤‡éƒ¨ä½</label>
          <div class="checkbox-group">
            <label><input type="checkbox" class="equip-checkbox" value="1"> æ­¦å™¨</label>
            <label><input type="checkbox" class="equip-checkbox" value="2"> å¤´ç›”</label>
            <label><input type="checkbox" class="equip-checkbox" value="3"> æŠ¤è…•</label>
            <label><input type="checkbox" class="equip-checkbox" value="6"> è¡£æœ</label>
            <label><input type="checkbox" class="equip-checkbox" value="9"> ç¬¦å’’</label>
            <label><input type="checkbox" class="equip-checkbox" value="8"> é‹å­</label>
            <label><input type="checkbox" class="equip-checkbox" value="5"> è…°å¸¦</label>
            <label><input type="checkbox" class="equip-checkbox" value="4"> é¡¹é“¾</label>
            <label><input type="checkbox" class="equip-checkbox" value="7"> æˆ’æŒ‡</label>
            <label><input type="checkbox" class="equip-checkbox" value="10"> å‹‹ç« </label>
            <label><input type="checkbox" class="equip-checkbox" value="11"> å®çŸ³</label>
            <label><input type="checkbox" class="equip-checkbox" value="12"> ç¿…è†€</label>
            <label><input type="checkbox" class="equip-checkbox" value="15"> æ³•å®</label>
            <label><input type="checkbox" class="equip-checkbox" value="14"> åéª‘</label>
            <label><input type="checkbox" class="equip-checkbox" value="13"> ç›¾ç‰Œ</label>
            <label><input type="checkbox" class="equip-checkbox" value="16"> æ—¶è£…</label>
            <label><input type="checkbox" class="equip-checkbox" value="17"> æ–—ç¬ </label>
            <label><input type="checkbox" class="equip-checkbox" value="33"> å…¶ä»–</label>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>æœ€ä½ä»·æ ¼</label>
            <input id="priceStart" type="number" value="1" />
          </div>
          <div class="form-group">
            <label>æœ€é«˜ä»·æ ¼</label>
            <input id="priceEnd" type="number" value="99" />
          </div>
          <div class="form-group">
            <label>æœˆå¡å‰©ä½™å¤©æ•° â‰¥</label>
            <input id="cardDays" type="number" value="0" />
          </div>
          <div class="form-group">
            <label>å……å€¼é‡‘é¢ â‰¥</label>
            <input id="recharge" type="number" value="0" />
          </div>
        </div>

        <div class="form-group">
          <label>æµæ´¾ç­›é€‰ï¼ˆæ”¯æŒå¤šä¸ªï¼‰</label>
          <input id="flow" placeholder="ä¾‹å¦‚ï¼šé“ç„,é¬¼ç‹ é’äº‘(ä¸å¡«åˆ™ä¸ç­›é€‰)" />
        </div>
      </div>

      <div class="card">
        <h2>ğŸ” è´¦å·è®¾ç½®</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>è´¦å·</label>
            <input id="username" placeholder="è¯·è¾“å…¥è´¦å·" />
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input id="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " />
          </div>
        </div>

        <div class="form-group">
          <label>æ‰‹åŠ¨ä¸‹å•å•†å“ID</label>
          <div class="form-grid" style="grid-template-columns: 1fr auto;">
            <input id="manualGoodsId" placeholder="è¾“å…¥å•†å“ID" />
            <button onclick="manualCreateOrder()" class="btn-secondary" style="margin-top: 0;">æ‰‹åŠ¨ä¸‹å•</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ ç›‘å¬è®¾ç½®</h2>
        <div class="checkbox-row">
          <label><input type="checkbox" id="debug" /> Debugè¯¦ç»†æ—¥å¿—</label>
          <label><input type="checkbox" id="barkJump" /> Bark æ¨é€å¯ç‚¹å‡»è·³è½¬å•†å“é¡µ</label>
          <label><input type="checkbox" id="autoOrder" /> å‘½ä¸­åè‡ªåŠ¨ä¸‹å• + Bark</label>
        </div>

        <div class="form-group">
          <label>Bark Key</label>
          <input id="bark" placeholder="https://api.day.app/ä½ çš„key" />
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰</label>
            <input id="interval" type="number" value="1800" />
          </div>
          <div class="form-group">
            <label>æ¯æ‰¹å¹¶å‘æ£€æµ‹IDæ•°</label>
            <input id="batchSize" type="number" value="5" />
          </div>
          <div class="form-group">
            <label>ç™»å½•å¤±è´¥é‡è¯•æ¬¡æ•°</label>
            <input id="loginRetry" type="number" value="3" />
          </div>
          <div class="form-group">
            <label>ä¸‹å•å¤±è´¥é‡è¯•æ¬¡æ•°</label>
            <input id="orderRetry" type="number" value="3" />
          </div>
        </div>

        <div class="btn-row">
          <button onclick="startMonitor()" class="btn-primary">â–¶ï¸ å¼€å§‹ç›‘å¬</button>
          <button class="btn-stop" onclick="stopMonitor()">â¹ï¸ åœæ­¢</button>
          <button class="btn-save" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        </div>
      </div>

      <div class="card">
        <h2>â° å®šæ—¶ä¸‹å•ä»»åŠ¡åˆ—è¡¨</h2>
        <div id="taskList" class="task-list">
          <div class="no-tasks">æš‚æ— å®šæ—¶ä»»åŠ¡</div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“ è¿è¡Œæ—¥å¿—</h2>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <h2>ğŸ¯ å‘½ä¸­å•†å“åˆ—è¡¨</h2>
        <div id="matchedGoodsList" class="matched-goods-list">
          <div class="no-matched">æš‚æ— å‘½ä¸­è®°å½•ï¼Œå¼€å§‹ç›‘å¬åå‘½ä¸­ä¼šæ˜¾ç¤ºåœ¨æ­¤</div>
        </div>
      </div>
    </div>

  
    <div id="tab-scan" class="hidden">
    
      <div class="card">
        <h1>ç­›é€‰ä»·å€¼å•†å“</h1>
        <div id="val_statusBar" class="status-bar hidden"></div>
      </div>

      <div class="card">
        <h2>åŸºç¡€ç­›é€‰</h2>
        <label>èŒä¸šï¼ˆå¯å¤šé€‰ï¼‰</label>
        <div class="checkbox-group">
          <label><input type="checkbox" class="val-job-cb" value="1"> æˆ˜å£«</label>
          <label><input type="checkbox" class="val-job-cb" value="2"> æ³•å¸ˆ</label>
          <label><input type="checkbox" class="val-job-cb" value="3"> æœ¯å£«</label>
        </div>
        <div class="checkbox-row">
          <label><input type="checkbox" id="val_onlyPresale"> ä»…ç›‘å¬é¢„å”®å•†å“</label>
          <label><input type="checkbox" id="val_debug"> Debug è¯¦ç»†æ—¥å¿—</label>
        </div>
      </div>

      <div class="card">
        <h2>è¿›é˜¶ç­›é€‰ï¼ˆç•™ç©ºåˆ™ä¸ç­›ï¼‰</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>æµæ´¾ç­›é€‰ï¼ˆå¤šä¸ªç”¨é€—å·/ç©ºæ ¼åˆ†éš”ï¼‰</label>
            <input type="text" id="val_flow" placeholder="ä¾‹å¦‚ï¼šå¤©å¿ é“ç„ é’äº‘" />
          </div>
          <div class="form-group">
            <label>å……å€¼é‡‘é¢ â‰¥</label>
            <input type="number" id="val_recharge" value="0" min="0" placeholder="0" />
          </div>
          <div class="form-group">
            <label>æœˆå¡å‰©ä½™å¤©æ•° â‰¥</label>
            <input type="number" id="val_cardDays" value="0" min="0" placeholder="0" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ä»·å€¼å…¬å¼</h2>
        <div class="formula-options">
          <label class="formula-option">
            <input type="radio" name="formula" value="1" id="val_formula1" checked>
            <span class="formula-desc">
              <strong>å…¬å¼ä¸€</strong>
              <span class="line">æœ‰æœˆå¡ï¼š(å•†è¡Œ + æŠ¼é•–) / 300 &gt; å”®ä»·</span>
              <span class="line">æ— æœˆå¡ï¼š(å•†è¡Œ + æŠ¼é•–) / 300 - 30 &gt; å”®ä»·</span>
            </span>
          </label>
          <label class="formula-option">
            <input type="radio" name="formula" value="2" id="val_formula2">
            <span class="formula-desc">
              <strong>å…¬å¼äºŒ</strong>
              <span class="line">æœ‰æœˆå¡ï¼šå•†è¡Œ / 300 &gt; å”®ä»·</span>
              <span class="line">æ— æœˆå¡ï¼šå•†è¡Œ / 300 - 30 &gt; å”®ä»·</span>
            </span>
          </label>
          <label class="formula-option">
            <input type="radio" name="formula" value="3" id="val_formula3">
            <span class="formula-desc">
              <strong>å…¬å¼ä¸‰</strong>
              <span class="line">æœ‰æœˆå¡ï¼š(å•†è¡Œ / 300 + æŠ¼é•– / 300 Ã— 0.66) &gt; å”®ä»·</span>
              <span class="line">æ— æœˆå¡ï¼š(å•†è¡Œ / 300 + æŠ¼é•– / 300 Ã— 0.66) - 30 &gt; å”®ä»·</span>
            </span>
          </label>
        </div>
        <div class="formula-threshold">
          <label>é˜ˆå€¼ï¼ˆç•™ç©º=0ï¼Œå¡« -30 å³ä»·å€¼-30ï¼Œå¡« 20 å³ä»·å€¼+20ï¼‰</label>
          <input type="number" id="val_threshold" placeholder="ä¾‹å¦‚ -30 æˆ– 20" step="1" />
        </div>
      </div>

      <div class="card">
        <label>æ¯æ‰¹å¹¶å‘æ£€æµ‹ ID æ•°</label>
        <input type="number" id="val_batchSize" value="5" min="1" max="20" />
        <div class="btn-row">
          <button id="val_btnStart" class="btn-primary">å¯åŠ¨ç›‘å¬</button>
          <button id="val_btnStop" class="btn-stop" disabled>åœæ­¢</button>
          <button id="val_btnSave" class="btn-save">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
          <h2 style="margin-bottom: 0;">å€¼å¾—åˆ—è¡¨</h2>
          <button 
            type="button"
            class="btn-stop" 
            style="padding: 6px 12px; font-size: 12px;" 
            onclick="valClearWorthList()"
          >
            æ¸…ç©ºåˆ—è¡¨
          </button>
        </div>
        <div id="val_worthList" class="matched-goods-list">
          <div class="no-matched">æš‚æ— ï¼Œæ»¡è¶³ä»·å€¼å…¬å¼çš„å•†å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
        </div>
      </div>

      <div class="card">
        <h2>è¿è¡Œæ—¥å¿—</h2>
        <div class="log" id="val_log"></div>
      </div>
    </div>
  </div>

  <script>
    // Tab åˆ‡æ¢é€»è¾‘
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');

      if (tab === 'home') {
        document.getElementById('tab-home').classList.remove('hidden');
        document.getElementById('tab-scan').classList.add('hidden');
      } else {
        document.getElementById('tab-home').classList.add('hidden');
        document.getElementById('tab-scan').classList.remove('hidden');
      }
    }
  </script>


  <script>
let timer = null;
let seen = new Set();
let running = false;
// Token ç®¡ç†
let token = "";
let tokenExpireTime = 0;
// é‡è¯•é…ç½®
const RETRY_DELAYS = [1000, 3000, 5000];
const FAST_RETRY_DELAY = 0;
const BURST_MS = 2000;
const BURST_CONCURRENCY = 12;
const SUSTAIN_CONCURRENCY = 6;
// å®šæ—¶ä»»åŠ¡ç®¡ç†
let scheduledTasks = [];
let taskCheckTimer = null;
// å‘½ä¸­å•†å“åˆ—è¡¨ï¼ˆç”¨äºé¡µé¢åº•éƒ¨å±•ç¤ºï¼‰
let matchedGoodsList = [];
function log(msg) {
  const el = document.getElementById("log");
  const timestamp = new Date().toLocaleTimeString();
  el.innerHTML += `[${timestamp}] ${msg}<br>`;
  el.scrollTop = el.scrollHeight;
}
function showStatus(msg, type = 'success') {
  const statusBar = document.getElementById('statusBar');
  statusBar.textContent = msg;
  statusBar.className = 'status-bar';
  if (type === 'error') statusBar.classList.add('error');
  if (type === 'warning') statusBar.classList.add('warning');
  statusBar.classList.remove('hidden');
}
function onTypeChange() {
  const type = document.getElementById("type").value;
  document.getElementById("jobBox").classList.toggle("hidden", type !== "99");
  document.getElementById("equipBox").classList.toggle("hidden", type !== "1");
}
function getCheckedJobs() {
  return Array.from(document.querySelectorAll('.job-checkbox:checked'))
    .map(i => i.value)
    .join(",");
}
function getCheckedEquipments() {
  return Array.from(document.querySelectorAll('.equip-checkbox:checked'))
    .map(i => i.value)
    .join(",");
}
function buildApiUrl(skip, maxCount) {
  const type = typeEl.value;
  const priceStart = priceStartEl.value;
  const priceEnd = priceEndEl.value;
  const timestamp = Date.now();
  let url = `https://api.52108.com/api/services/cbg/Goods/GetIndexGoodsPaged?GameServerId=&TypeList=&PriceStart=${priceStart}&PriceEnd=${priceEnd}&EquipmentTypeList=&Id=&Name=&Sorting=&SkipCount=${skip}&MaxResultCount=${maxCount}&OnlyPlayed=false&time=${timestamp}&type=${type}`;
  if (type === "99") {
    const jobList = getCheckedJobs();
    if (jobList) {
      url += `&RoleJobList=${encodeURIComponent(jobList)}`;
    }
  }
  if (type === "1") {
    const equipList = getCheckedEquipments();
    if (equipList) {
      url = url.replace('EquipmentTypeList=', `EquipmentTypeList=${encodeURIComponent(equipList)}`);
    }
  }
  return url;
}
async function fetchTotal() {
  const url = buildApiUrl(0, 1);
  const res = await fetch(url);
  const data = await res.json();
  return data.result?.totalCount || 0;
}
async function fetchAllItems(total) {
  // ä¸ºäº†åº”å¯¹æ¥å£å¶å°”æœåŠ¡ç¹å¿™æ—¶è¿”å›å¼‚å¸¸æ•°æ®çš„æƒ…å†µï¼š
  // 1. ä¸€æ¬¡æ€§æ‹‰å– total+100 æ¡ï¼Œå°½é‡è¦†ç›–è¿™æ¬¡ totalCount é™„è¿‘çš„å…¨éƒ¨æ•°æ®ï¼›
  // 2. å†æ¬¡è¯»å– totalCountï¼Œå¯¹æ¯”æœ¬æ¬¡ä¸åˆå§‹çš„å·®å€¼ï¼Œè‹¥è¶…è¿‡ 100 è§†ä¸ºå¼‚å¸¸å¹¶é‡è¯•3æ¬¡ã€‚
  let currentTotal = total;
  let attempt = 0;
  let lastItems = [];
  while (attempt < 3) {
    const safeMax = currentTotal + 100;
    const url = buildApiUrl(0, safeMax);
    const res = await fetch(url);
    const data = await res.json();
    const items = data.result?.items || [];
    lastItems = items;

    // å†æ¬¡è·å– totalCount åšæ ¡éªŒ
    let newTotal = 0;
    try {
      newTotal = await fetchTotal();
    } catch (e) {
      newTotal = currentTotal;
    }
    const diff = Math.abs(newTotal - total);
    if (diff <= 100) {
      // totalCount ä¸æœ€åˆç»“æœåœ¨ 100 ä»¥å†…ï¼Œè®¤ä¸ºæ­£å¸¸
      return items;
    }

    log(`âš  åˆ—è¡¨ totalCount å¼‚å¸¸ï¼Œåˆå§‹=${total}ï¼Œå½“å‰=${newTotal}ï¼Œå·®å€¼=${diff}ï¼Œå°è¯•é‡æ–°è·å– (ç¬¬ ${attempt + 1} æ¬¡)...`);
    currentTotal = newTotal;
    attempt++;
    await delay(500);
  }
  // å¤šæ¬¡é‡è¯•ä¾ç„¶å¼‚å¸¸ï¼Œè¿”å›æœ€åä¸€æ¬¡æ‹¿åˆ°çš„æ•°æ®ï¼Œé¿å…æ­»å¾ªç¯
  return lastItems;
}
async function getRoleExtra(goodsId) {
  const t0 = Date.now();
  const res = await fetch(`https://api.52108.com/api/services/app/GameRoleInfo/GetGameRoleInfo?GoodsId=${goodsId}`);
  const j = await res.json();
  const html = j.result[0].data;
  const cardMatch = html.match(/æœˆå¡åˆ°æœŸæ—¶é—´ï¼š.*?val'>(.*?)</);
  let days = 0;
  if (cardMatch && cardMatch[1] !== "æ— æœˆå¡") {
    days = Math.floor((new Date(cardMatch[1]) - new Date()) / 86400000);
  }
  const flowMatch = html.match(/æµæ´¾ï¼š.*?val'>(.*?)</);
  const flow = flowMatch ? flowMatch[1] : "";
  const rechargeMatch = html.match(/å……å€¼ï¼š.*?val'>(\d+)</);
  const recharge = rechargeMatch ? Number(rechargeMatch[1]) : 0;
  const cost = Date.now() - t0;
  return { days, flow, recharge, cost };
}
function parseFlows(text) {
  if (!text) return [];
  return text.split(/[,\sã€ï¼Œ]+/).map(s => s.trim()).filter(Boolean);
}
function matchFlow(target, flows) {
  if (flows.length === 0) return true;
  return flows.some(f => target.includes(f));
}
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
function isTerminalOrderError(message) {
  if (!message) return false;
  const msg = String(message);
  return (
    msg.includes("å½“å‰å•†å“äº¤æ˜“ä¸­") ||
    msg.includes("å·²å”®") ||
    msg.includes("ä¸å­˜åœ¨") ||
    msg.includes("ä¸‹æ¶") ||
    msg.includes("åº“å­˜ä¸è¶³") ||
    msg.includes("ä¸å¯è´­ä¹°")
  );
}
async function rushOrder(goodsId, customConcurrency) {
  const burstConcurrency = customConcurrency || BURST_CONCURRENCY;
  const start = Date.now();
  const burstEnd = start + BURST_MS;
  let active = 0;
  let done = false;
  let finalResult = null;
  const spawn = () => {
    if (done) return;
    active++;
    (async () => {
      try {
        const res = await createOrder(goodsId, 0, { fastRetry: true, maxRetryOverride: 0 });
        if (res && res.success) {
          done = true;
          finalResult = res;
        } else if (res && res.scheduledTask) {
          done = true;
          finalResult = res;
        } else {
          const msg = JSON.stringify(res?.error?.message || res);
          if (isTerminalOrderError(msg)) {
            done = true;
            finalResult = { success: false, terminalError: true, message: msg };
          }
        }
      } catch (e) {
        const msg = e?.message || String(e);
        if (isTerminalOrderError(msg)) {
          done = true;
          finalResult = { success: false, terminalError: true, message: msg };
        }
      } finally {
        active--;
      }
    })();
  };
  while (!done) {
    const now = Date.now();
    const targetConcurrency = now <= burstEnd ? burstConcurrency : SUSTAIN_CONCURRENCY;
    while (!done && active < targetConcurrency) {
      spawn();
    }
    if (done) break;
    await delay(FAST_RETRY_DELAY);
  }
  return finalResult;
}
function saveToken(accessToken) {
  token = accessToken;
  tokenExpireTime = Date.now() + 23 * 60 * 60 * 1000;
  const tokenData = {
    token: accessToken,
    expireTime: tokenExpireTime,
    username: usernameEl.value.trim()
  };
  localStorage.setItem("barkMonitorToken", JSON.stringify(tokenData));
  log("âœ” Token å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨");
}
function loadToken() {
  const tokenStr = localStorage.getItem("barkMonitorToken");
  if (!tokenStr) return false;
  try {
    const tokenData = JSON.parse(tokenStr);
    if (tokenData.expireTime && tokenData.expireTime > Date.now()) {
      if (tokenData.username === usernameEl.value.trim()) {
        token = tokenData.token;
        tokenExpireTime = tokenData.expireTime;
        const remainHours = Math.floor((tokenExpireTime - Date.now()) / 3600000);
        log(`âœ” å·²åŠ è½½æœ¬åœ° Tokenï¼ˆå‰©ä½™æœ‰æ•ˆæœŸçº¦ ${remainHours} å°æ—¶ï¼‰`);
        showStatus(`Token æœ‰æ•ˆï¼Œå‰©ä½™ ${remainHours} å°æ—¶`, 'success');
        return true;
      } else {
        log("æœ¬åœ° Token ç”¨æˆ·åä¸åŒ¹é…ï¼Œéœ€é‡æ–°ç™»å½•");
      }
    } else {
      log("æœ¬åœ° Token å·²è¿‡æœŸï¼Œéœ€é‡æ–°ç™»å½•");
    }
  } catch (e) {
    log("åŠ è½½æœ¬åœ° Token å¤±è´¥: " + e.message);
  }
  localStorage.removeItem("barkMonitorToken");
  token = "";
  tokenExpireTime = 0;
  return false;
}
function isTokenExpiringSoon() {
  if (!token || !tokenExpireTime) return true;
  return (tokenExpireTime - Date.now()) < 60 * 60 * 1000;
}
async function login(user, pass, retryCount = 0) {
  const maxRetry = Number(loginRetryEl.value) || 3;
  try {
    log(`æ­£åœ¨ç™»å½•... (å°è¯• ${retryCount + 1}/${maxRetry + 1})`);
    showStatus(`ç™»å½•ä¸­... (å°è¯• ${retryCount + 1}/${maxRetry + 1})`, 'warning');
    const res = await fetch("https://api.52108.com/api/TokenAuth/AccountAuthenticate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userName: user, password: pass })
    });
    const data = await res.json();
    if (!data.success) {
      throw new Error(data.error?.message || "ç™»å½•å¤±è´¥");
    }
    saveToken(data.result.accessToken);
    log("âœ” ç™»å½•æˆåŠŸ");
    showStatus("ç™»å½•æˆåŠŸ", 'success');
    return true;
  } catch (e) {
    log(`âœ˜ ç™»å½•å¤±è´¥: ${e.message}`);
    if (retryCount < maxRetry) {
      const delayMs = RETRY_DELAYS[retryCount] || 5000;
      log(`${delayMs / 1000} ç§’åé‡è¯•ç™»å½•...`);
      await delay(delayMs);
      return login(user, pass, retryCount + 1);
    } else {
      log(`âœ˜ ç™»å½•å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•° (${maxRetry + 1})`);
      showStatus(`ç™»å½•å¤±è´¥: ${e.message}`, 'error');
      throw new Error("ç™»å½•å¤±è´¥: " + e.message);
    }
  }
}
async function ensureLogin() {
  const user = usernameEl.value.trim();
  const pass = passwordEl.value.trim();
  if (!user || !pass) {
    throw new Error("è¯·å¡«å†™è´¦å·å’Œå¯†ç ");
  }
  if (token && !isTokenExpiringSoon()) {
    return true;
  }
  if (!token && loadToken()) {
    return true;
  }
  log("Token æ— æ•ˆæˆ–å³å°†è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°ç™»å½•...");
  return await login(user, pass);
}
async function getGoodsDetail(goodsId) {
  try {
    const res = await fetch(`https://api.52108.com/api/services/cbg/Goods/GetById?id=${goodsId}`);
    const data = await res.json();
    if (data.success && data.result) {
      return data.result;
    }
    return null;
  } catch (e) {
    log(`æŸ¥è¯¢å•†å“è¯¦æƒ…å¤±è´¥ ID=${goodsId}: ${e.message}`);
    return null;
  }
}
async function createScheduledTask(goodsId, errorMessage) {
  const existing = scheduledTasks.find(t => t.goodsId === goodsId);
  if (existing) {
    log(`â° å•†å“ID=${goodsId} å·²æœ‰å®šæ—¶ä»»åŠ¡ï¼Œä¸å†é‡å¤åˆ›å»º`);
    return existing;
  }
  log(`â° æ£€æµ‹åˆ°å…¬ç¤ºæœŸé™åˆ¶ï¼Œæ­£åœ¨æŸ¥è¯¢å•†å“è¯¦æƒ…...`);
  const goodsDetail = await getGoodsDetail(goodsId);
  if (!goodsDetail || !goodsDetail.noticeEndTime) {
    log(`âœ˜ æ— æ³•è·å–å•†å“ ID=${goodsId} çš„å…¬ç¤ºç»“æŸæ—¶é—´`);
    return;
  }
  const noticeEndTime = new Date(goodsDetail.noticeEndTime);
  const taskId = `task_${goodsId}_${Date.now()}`;
  const task = {
    id: taskId,
    goodsId: goodsId,
    goodsName: goodsDetail.name || `å•†å“${goodsId}`,
    server: goodsDetail.gameServer?.subName || "æœªçŸ¥åŒºæœ",
    price: goodsDetail.price,
    noticeEndTime: noticeEndTime.getTime(),
    noticeEndTimeStr: goodsDetail.noticeEndTime,
    status: 'pending',
    statusMessage: '',
    createTime: Date.now(),
    orderNumber: null,
    // æå‰æŠ¢å’Œå¹¶å‘è®¾ç½®ï¼ˆé»˜è®¤å€¼ï¼‰
    advanceMs: 0,
    customConcurrency: BURST_CONCURRENCY
  };
  scheduledTasks.push(task);
  saveScheduledTasks();
  renderTaskList();
  log(`âœ” å·²åˆ›å»ºå®šæ—¶ä»»åŠ¡: ${task.goodsName} | ${task.server} | ${task.price}å…ƒ | å°†åœ¨ ${noticeEndTime.toLocaleString()} è‡ªåŠ¨ä¸‹å•`);
  await pushBark("åˆ›å»ºå®šæ—¶ä¸‹å•ä»»åŠ¡", `${task.goodsName} | ${task.server} | ${task.price}å…ƒ | ${noticeEndTime.toLocaleString()}`, `http://dms.52108.com/#/pages/shop/detail?id=${goodsId}`);
  return task;
}
function saveScheduledTasks() {
  localStorage.setItem("scheduledTasks", JSON.stringify(scheduledTasks));
}
function loadScheduledTasks() {
  const tasksStr = localStorage.getItem("scheduledTasks");
  if (!tasksStr) return;
  try {
    scheduledTasks = JSON.parse(tasksStr);
    // å…¼å®¹æ•°æ®ï¼šä¸ºæ²¡æœ‰æ–°å­—æ®µçš„ä»»åŠ¡æ·»åŠ é»˜è®¤å€¼
    scheduledTasks.forEach(task => {
      if (task.advanceMs === undefined || task.advanceMs === null) {
        task.advanceMs = 0;
      }
      if (task.customConcurrency === undefined) task.customConcurrency = BURST_CONCURRENCY;
    });
    log(`âœ” å·²åŠ è½½ ${scheduledTasks.length} ä¸ªå®šæ—¶ä»»åŠ¡`);
    renderTaskList();
  } catch (e) {
    log("åŠ è½½å®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.message);
    scheduledTasks = [];
  }
}
function deleteTask(taskId) {
  scheduledTasks = scheduledTasks.filter(t => t.id !== taskId);
  saveScheduledTasks();
  renderTaskList();
  log(`å·²åˆ é™¤ä»»åŠ¡ ${taskId}`);
}
// æ›´æ–°ä»»åŠ¡çš„æå‰æŠ¢å’Œå¹¶å‘è®¾ç½®
function updateTaskSettings(taskId) {
  const task = scheduledTasks.find(t => t.id === taskId);
  if (!task) return;

  const advanceInput = document.getElementById(`advance_${taskId}`);
  const concurrencyInput = document.getElementById(`concurrency_${taskId}`);

  if (advanceInput) {
    const raw = advanceInput.value.trim();
    if (raw !== '') {
      const advanceValue = parseInt(raw, 10);
      if (!isNaN(advanceValue)) {
        // é™åˆ¶åœ¨ -60000~60000 æ¯«ç§’ï¼ˆè´Ÿæ•°=æå‰ï¼Œæ­£æ•°=å»¶åï¼‰
        task.advanceMs = Math.max(-60000, Math.min(60000, advanceValue));
      }
    }
  }

  if (concurrencyInput) {
    const raw = concurrencyInput.value.trim();
    if (raw !== '') {
      const concurrencyValue = parseInt(raw, 10);
      if (!isNaN(concurrencyValue)) {
        const safeConcurrency = concurrencyValue;
        task.customConcurrency = Math.max(1, Math.min(50, safeConcurrency));
      }
    }
  }

  saveScheduledTasks();
  renderTaskList();
  log(`âœ” å·²æ›´æ–°ä»»åŠ¡ ${task.goodsName} çš„æŠ¢è´­è®¾ç½®`);
}
function renderTaskList() {
  const container = document.getElementById('taskList');
  if (scheduledTasks.length === 0) {
    container.innerHTML = '<div class="no-tasks">æš‚æ— å®šæ—¶ä»»åŠ¡</div>';
    return;
  }
  const now = Date.now();
  container.innerHTML = scheduledTasks.map(task => {
    const noticeEndTime = task.noticeEndTime;
    // è®¡ç®—å®é™…æ‰§è¡Œæ—¶é—´ï¼ˆåç§»é‡ï¼Œè´Ÿæ•°=æå‰ï¼Œæ­£æ•°=å»¶åï¼‰
    const advanceMs = task.advanceMs || 0;
    const executeTime = noticeEndTime + advanceMs;
    const timeRemaining = executeTime - now;
    let statusClass = task.status;
    let statusText = '';
    let countdown = '';
    if (task.status === 'success') {
      const paymentLink = task.orderId 
        ? ` | <a href="${getPaymentUrl(task.orderId)}" target="_blank" style="color: #ff6a00; font-weight: bold;">ç‚¹å‡»å»ä»˜æ¬¾</a>`
        : '';
      statusText = `ä¸‹å•æˆåŠŸ è®¢å•å·:${task.orderNumber}${paymentLink}`;
    } else if (task.status === 'error') {
      statusText = `ä¸‹å•å¤±è´¥: ${task.statusMessage}`;
    } else if (task.status === 'processing') {
      statusText = 'ä¸‹å•ä¸­...';
    } else if (timeRemaining < 0) {
      statusText = 'å·²è¿‡æœŸ';
      statusClass = 'expired';
    } else {
      statusText = 'ç­‰å¾…ä¸­';
      const hours = Math.floor(timeRemaining / 3600000);
      const minutes = Math.floor((timeRemaining % 3600000) / 60000);
      const seconds = Math.floor((timeRemaining % 60000) / 1000);
      countdown = `<span class="task-countdown">å€’è®¡æ—¶: ${hours}h ${minutes}m ${seconds}s</span>`;
    }

    // æ„å»ºè®¾ç½®åŒºåŸŸï¼ˆä»…åœ¨ç­‰å¾…ä¸­çŠ¶æ€æ˜¾ç¤ºï¼‰
    let settingsHtml = '';
    if (task.status === 'pending') {
      settingsHtml = `
        <div class="task-settings">
          <div style="margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">âš™ï¸ æŠ¢è´­è®¾ç½®</div>
          <div class="task-settings-grid">
            <div class="task-setting-item">
              <label>æŠ¢è´­åç§»ï¼ˆæ¯«ç§’ï¼Œè´Ÿæ•°=æå‰ï¼Œæ­£æ•°=å»¶åï¼‰</label>
              <input 
                type="number" 
                id="advance_${task.id}" 
                value="${advanceMs}" 
                min="-60000" 
                max="60000"
                step="10"
              />
            </div>
            <div class="task-setting-item">
              <label>å¹¶å‘æ•°é‡</label>
              <input 
                type="number" 
                id="concurrency_${task.id}" 
                value="${task.customConcurrency}" 
                min="1" 
                max="50"
              />
            </div>
          </div>
          <div style="margin-top: 8px;">
            <button 
              type="button" 
              class="btn-save" 
              style="padding:6px 12px; font-size:12px;"
              onclick="updateTaskSettings('${task.id}')"
            >
              ä¿å­˜æŠ¢è´­è®¾ç½®
            </button>
          </div>
          ${advanceMs !== 0 ? `<div style="margin-top: 8px; font-size: 12px; color: #666;">
            å®é™…æŠ¢è´­æ—¶é—´ï¼š${new Date(executeTime).toLocaleString()}ï¼ˆç›¸å¯¹å…¬ç¤ºç»“æŸ ${advanceMs > 0 ? 'å»¶å' : 'æå‰'} ${Math.abs(advanceMs)} æ¯«ç§’ï¼‰
          </div>` : ''}
        </div>
      `;
    }

    // æ˜¾ç¤ºå½“å‰è®¾ç½®çš„æ ‡è®°
    const settingsBadges = task.status === 'pending' 
      ? (advanceMs !== 0 || task.customConcurrency !== BURST_CONCURRENCY
        ? `<span class="task-setting-badge">${advanceMs > 0 ? 'å»¶å' : 'æå‰'}${Math.abs(advanceMs)}ms</span><span class="task-setting-badge">å¹¶å‘${task.customConcurrency}</span>`
        : '')
      : '';

    return `
      <div class="task-item ${statusClass}">
        <button class="task-delete" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
        <div class="task-info">
          <div>
            <strong>${task.goodsName}</strong>
            <span class="task-status ${statusClass}">${statusText}</span>
            ${settingsBadges}
          </div>
          <div>å•†å“ID: <a href="http://dms.52108.com/#/pages/shop/detail?id=${task.goodsId}" target="_blank" style="color: #4da3ff; text-decoration: underline;">${task.goodsId}</a> | åŒºæœ: ${task.server} | ä»·æ ¼: ${task.price}å…ƒ</div>
          <div>å…¬ç¤ºç»“æŸæ—¶é—´: ${new Date(noticeEndTime).toLocaleString()}ï¼ˆåŸå§‹: ${escapeHtml(task.noticeEndTimeStr || '')}ï¼‰</div>
          ${countdown ? `<div>${countdown}</div>` : ''}
        </div>
        ${settingsHtml}
      </div>
    `;
  }).join('');
}
function renderMatchedGoodsList() {
  const container = document.getElementById('matchedGoodsList');
  if (!container) return;
  if (matchedGoodsList.length === 0) {
    container.innerHTML = '<div class="no-matched">æš‚æ— å‘½ä¸­è®°å½•ï¼Œå¼€å§‹ç›‘å¬åå‘½ä¸­ä¼šæ˜¾ç¤ºåœ¨æ­¤</div>';
    return;
  }
  container.innerHTML = matchedGoodsList.map(m => {
    const url = `http://dms.52108.com/#/pages/shop/detail?id=${m.id}`;
    const rechargeMark = m.recharge >= 0 ? `${m.recharge}âœ”` : `${m.recharge}âœ˜`;
    // å‘½ä¸­åˆ—è¡¨ä¸­çš„ Debug é£æ ¼æ—¥å¿—å·²ç»åœ¨ä¸Šæ–¹è¾“å‡ºï¼Œè¿™é‡Œä¸»è¦å±•ç¤ºæ•°æ®åŠä¸€é”®æ“ä½œ
    return `
      <div class="matched-item">
        <span class="matched-name">${escapeHtml(m.name)}</span>
        <span class="matched-meta">ID: <a href="${url}" target="_blank">${m.id}</a></span>
        <span class="matched-meta">åŒºæœ: ${escapeHtml(m.server)}</span>
        <span class="matched-meta">ä»·æ ¼: ${m.price}å…ƒ</span>
        <span class="matched-meta">å……å€¼: ${m.recharge}</span>
        <span class="matched-meta">æœˆå¡: ${m.days}å¤©</span>
        <span class="matched-meta">æµæ´¾: ${escapeHtml(m.flow)}</span>
        <span class="matched-meta">${m.hitTime}</span>
        <button 
          type="button"
          class="btn-primary"
          style="margin-left:auto; padding:4px 10px; font-size:12px;"
          onclick="oneClickOrder(${m.id})"
        >
          ä¸€é”®ä¸‹å•
        </button>
      </div>
    `;
  }).join('');
}
function escapeHtml(str) {
  if (str == null) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
async function checkScheduledTasks() {
  const now = Date.now();
  for (const task of scheduledTasks) {
    if (task.status !== 'pending') continue;
    
    // è®¡ç®—å®é™…æ‰§è¡Œæ—¶é—´ï¼ˆåç§»é‡ï¼Œè´Ÿæ•°=æå‰ï¼Œæ­£æ•°=å»¶åï¼‰
    const advanceMs = task.advanceMs || 0;
    const executeTime = task.noticeEndTime + advanceMs;
    const timeUntil = executeTime - now;
    // åœ¨æ‰§è¡Œæ—¶é—´åˆ°è¾¾æ—¶ï¼ˆæˆ–å·²è¿‡æœŸä½†æœªè¶…è¿‡60ç§’ï¼‰è§¦å‘ä¸‹å•
    if (timeUntil <= 3000 && timeUntil > -60000) {
      task.status = 'processing';
      task.statusMessage = 'ä¸‹å•ä¸­...';
      saveScheduledTasks();
      renderTaskList();
      let advanceInfo = '';
      if (advanceMs !== 0) {
        const dir = advanceMs > 0 ? 'å»¶å' : 'æå‰';
        advanceInfo = ` (${dir}${Math.abs(advanceMs)}æ¯«ç§’ï¼Œå¹¶å‘${task.customConcurrency})`;
      }
      log(`â° å®šæ—¶ä»»åŠ¡åˆ°æœŸï¼Œå¼€å§‹ä¸‹å•: ${task.goodsName} (ID=${task.goodsId})${advanceInfo}`);
      try {
        // ä½¿ç”¨ä»»åŠ¡è‡ªå®šä¹‰çš„å¹¶å‘æ•°é‡
        const orderRes = await rushOrder(task.goodsId, task.customConcurrency);
        if (orderRes && orderRes.success) {
          const orderId = orderRes.result.id;
          const orderNumber = orderRes.result.orderNumber;
          const paymentUrl = getPaymentUrl(orderId);
          const paymentLink = `<a href="${paymentUrl}" target="_blank">ç‚¹å‡»å»ä»˜æ¬¾</a>`;
          task.status = 'success';
          task.orderId = orderId;
          task.orderNumber = orderNumber;
          task.statusMessage = 'ä¸‹å•æˆåŠŸ';
          log(`âœ” å®šæ—¶ä»»åŠ¡ä¸‹å•æˆåŠŸ è®¢å•å·=${orderNumber} | ${paymentLink}`);
          await pushBark("å®šæ—¶ä¸‹å•æˆåŠŸ", `${task.goodsName} | è®¢å•å·:${orderNumber} | ç‚¹å‡»å»ä»˜æ¬¾`, paymentUrl);
        } else if (orderRes && orderRes.scheduledTask) {
          task.status = 'pending';
          task.statusMessage = 'å…¬ç¤ºæœŸé™åˆ¶';
          log(`â° ä»åœ¨å…¬ç¤ºæœŸï¼Œç»§ç»­ç­‰å¾…: ID=${task.goodsId}`);
        } else if (orderRes && orderRes.terminalError) {
          task.status = 'error';
          task.statusMessage = orderRes.message;
          log(`âœ˜ å®šæ—¶ä»»åŠ¡ä¸‹å•å¤±è´¥: ${orderRes.message}`);
        } else {
          task.status = 'error';
          task.statusMessage = 'ä¸‹å•å¤±è´¥';
          log(`âœ˜ å®šæ—¶ä»»åŠ¡ä¸‹å•å¤±è´¥: æœªçŸ¥é”™è¯¯`);
        }
      } catch (e) {
        task.status = 'error';
        task.statusMessage = e.message;
        log(`âœ˜ å®šæ—¶ä»»åŠ¡ä¸‹å•å¼‚å¸¸: ${e.message}`);
      }
      saveScheduledTasks();
      renderTaskList();
      return;
    } else if (timeUntil < -60000) {
      task.status = 'expired';
      task.statusMessage = 'ä»»åŠ¡å·²è¿‡æœŸ';
      saveScheduledTasks();
      renderTaskList();
    }
  }
}
function startTaskChecker() {
  if (taskCheckTimer) return;
  taskCheckTimer = setInterval(() => {
    checkScheduledTasks();
    // å¦‚æœå½“å‰æ­£åœ¨ç¼–è¾‘æŠ¢è´­è®¾ç½®è¾“å…¥æ¡†ï¼Œæš‚æ—¶ä¸è¦é‡ç»˜åˆ—è¡¨é¿å…æ‰“å­—è¢«æ‰“æ–­
    const active = document.activeElement;
    const editing =
      active &&
      typeof active.id === 'string' &&
      (active.id.startsWith('advance_') || active.id.startsWith('concurrency_'));
    if (!editing) {
      renderTaskList();
    }
  }, 300);
  log("âœ” å®šæ—¶ä»»åŠ¡æ£€æŸ¥å™¨å·²å¯åŠ¨");
}
function stopTaskChecker() {
  if (taskCheckTimer) {
    clearInterval(taskCheckTimer);
    taskCheckTimer = null;
  }
}
async function createOrder(goodsId, retryCount = 0, options = {}) {
  const maxRetry = Number.isInteger(options.maxRetryOverride)
    ? options.maxRetryOverride
    : (Number(orderRetryEl.value) || 3);
  const fastRetry = options.fastRetry === true;
  try {
    await ensureLogin();
    log(`æ­£åœ¨ç”Ÿæˆè®¢å• ID=${goodsId}... (å°è¯• ${retryCount + 1}/${maxRetry + 1})`);
    const t0 = Date.now();
    const res = await fetch("https://api.52108.com/api/services/cbg/Order/Create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ goodsId: Number(goodsId) })
    });
    const t1 = Date.now();
    log(`â± ä¸‹å•è¯·æ±‚è€—æ—¶ ${t1 - t0} ms (HTTP ${res.status}) ID=${goodsId}`);
    if (res.status === 401) {
      log("âš  æ£€æµ‹åˆ° 401 æœªæˆæƒï¼ŒToken å·²å¤±æ•ˆ");
      localStorage.removeItem("barkMonitorToken");
      token = "";
      tokenExpireTime = 0;
      if (retryCount < maxRetry) {
        log("æ­£åœ¨é‡æ–°ç™»å½•...");
        await ensureLogin();
        return createOrder(goodsId, retryCount + 1, options);
      } else {
        throw new Error("401 æœªæˆæƒï¼ŒToken å¤±æ•ˆ");
      }
    }
    const data = await res.json();
    if (!data.success && data.error?.code === 1011) {
      log(`âš  ${data.error.message}`);
      await createScheduledTask(goodsId, data.error.message);
      return { success: false, scheduledTask: true, error: data.error };
    }
    if (!data.success) {
      throw new Error(data.error?.message || JSON.stringify(data));
    }
    return data;
  } catch (e) {
    if (e.message && e.message.includes("å…¬ç¤ºæœŸ")) {
      log(`âš  æ£€æµ‹åˆ°å…¬ç¤ºæœŸé™åˆ¶: ${e.message}`);
      await createScheduledTask(goodsId, e.message);
      return { success: false, scheduledTask: true, error: { message: e.message } };
    }
    log(`âœ˜ ä¸‹å•å¤±è´¥ (å°è¯• ${retryCount + 1}/${maxRetry + 1}): ${e.message}`);
    if (retryCount < maxRetry) {
      const delayMs = fastRetry ? FAST_RETRY_DELAY : (RETRY_DELAYS[retryCount] || 5000);
      if (!fastRetry) {
        log(`${delayMs / 1000} ç§’åé‡è¯•ä¸‹å•...`);
      }
      if (delayMs > 0) {
        await delay(delayMs);
      }
      return createOrder(goodsId, retryCount + 1, options);
    } else {
      log(`âœ˜ ä¸‹å•å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•° (${maxRetry + 1})`);
      throw e;
    }
  }
}
async function manualCreateOrder() {
  const gid = manualGoodsIdEl.value.trim();
  if (!gid) {
    log("è¯·è¾“å…¥è¦ä¸‹å•çš„ goodsId");
    return;
  }
  try {
    const res = await createOrder(gid);
    if (res.success) {
      const orderId = res.result.id;
      const orderNumber = res.result.orderNumber;
      const paymentUrl = getPaymentUrl(orderId);
      const paymentLink = `<a href="${paymentUrl}" target="_blank">ç‚¹å‡»å»ä»˜æ¬¾</a>`;
      log(`âœ” æ‰‹åŠ¨ä¸‹å•æˆåŠŸ è®¢å•å·=${orderNumber} | ${paymentLink}`);
      showStatus(`æ‰‹åŠ¨ä¸‹å•æˆåŠŸ è®¢å•å·=${orderNumber}`, 'success');
      await pushBark("æ‰‹åŠ¨ä¸‹å•æˆåŠŸ", `è®¢å•å·:${orderNumber} | ç‚¹å‡»å»ä»˜æ¬¾`, paymentUrl);
    } else if (res.scheduledTask) {
      log(`â° æ£€æµ‹åˆ°å…¬ç¤ºæœŸï¼Œå·²åˆ›å»ºå®šæ—¶ä»»åŠ¡`);
      showStatus("å·²åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå°†è‡ªåŠ¨ä¸‹å•", 'warning');
    } else {
      log("âœ˜ æ‰‹åŠ¨ä¸‹å•å¤±è´¥:\n" + JSON.stringify(res, null, 2));
      showStatus("æ‰‹åŠ¨ä¸‹å•å¤±è´¥", 'error');
    }
  } catch (e) {
    log("æ‰‹åŠ¨ä¸‹å•å¼‚å¸¸: " + e.message);
    showStatus("æ‰‹åŠ¨ä¸‹å•å¼‚å¸¸: " + e.message, 'error');
  }
}
// å‘½ä¸­å•†å“åˆ—è¡¨ä¸­çš„â€œä¸€é”®ä¸‹å•â€
function oneClickOrder(goodsId) {
  manualGoodsIdEl.value = goodsId;
  manualCreateOrder();
}
function getPaymentUrl(orderId) {
  return `http://dms.52108.com/#/pages/trade/detail?id=${orderId}`;
}
async function pushBark(title, body, url) {
  const bark = barkEl.value.trim();
  if (!bark) return;
  const soundParam = "sound=update";
  const api = barkJumpEl.checked && url
    ? `${bark}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?url=${encodeURIComponent(url)}&${soundParam}`
    : `${bark}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?${soundParam}`;
  try {
    await fetch(api);
    log("âœ” Bark æ¨é€æˆåŠŸ");
  } catch (e) {
    log("âœ˜ Bark æ¨é€å¤±è´¥: " + e.message);
  }
}
async function check() {
  if (!running) return;
  try {
    const total = await fetchTotal();
    const type = typeEl.value;
    let filterInfo = `ä»·æ ¼${priceStartEl.value}-${priceEndEl.value}`;
    if (type === "99") {
      const jobs = getCheckedJobs();
      if (jobs) filterInfo += ` | èŒä¸š=${jobs}`;
    }
    if (type === "1") {
      const equips = getCheckedEquipments();
      if (equips) filterInfo += ` | è£…å¤‡=${equips}`;
    }
    log(`å½“å‰å¸‚åœºåŸºç¡€ç­›é€‰æ€»æ•°ï¼š${total} (${filterInfo})`);
    if (total === 0) return;
    const items = await fetchAllItems(total);
    const needDays = Number(cardDaysEl.value);
    const needRecharge = Number(rechargeEl.value);
    const needFlows = parseFlows(flowEl.value.trim());
    const debug = debugEl.checked;
    let matchCount = 0;
    const batchSize = Math.max(1, Number(batchSizeEl.value) || 1);
    for (let i = 0; i < items.length; i += batchSize) {
      if (!running) return;
      const batch = items.slice(i, i + batchSize);
      const results = await Promise.all(batch.map(async (item) => {
        try {
          const extra = await getRoleExtra(item.id);
          const server = item.gameServer?.subName || "æœªçŸ¥åŒºæœ";
          const okDays = extra.days >= needDays;
          const okRecharge = extra.recharge >= needRecharge;
          const okFlow = matchFlow(extra.flow, needFlows);
          if (debug) {
            log(`æ£€æµ‹ID=${item.id} | åŒºæœ=${server} | ä»·æ ¼=${item.price} | å……å€¼=${extra.recharge}${okRecharge ? "âœ”" : "âœ˜"} | æœˆå¡=${extra.days}${okDays ? "âœ”" : "âœ˜"} | æµæ´¾=${extra.flow}${okFlow ? "âœ”" : "âœ˜"} | è€—æ—¶=${extra.cost}ms`);
          }
          if (!okDays || !okRecharge || !okFlow) return null;
          if (seen.has(item.id)) return null;
          return { item, extra, server };
        } catch (e) {
          log(`æ£€æµ‹å•†å“ ID=${item.id} æ—¶å‡ºé”™: ${e.message}`);
          return null;
        }
      }));
      for (const r of results) {
        if (!r) continue;
        seen.add(r.item.id);
        matchCount++;
        matchedGoodsList.unshift({
          id: r.item.id,
          name: r.item.name || `å•†å“${r.item.id}`,
          server: r.server,
          price: r.item.price,
          recharge: r.extra.recharge,
          days: r.extra.days,
          flow: r.extra.flow,
          hitTime: new Date().toLocaleString()
        });
        renderMatchedGoodsList();
        const url = `http://dms.52108.com/#/pages/shop/detail?id=${r.item.id}`;
        const msg = `<a href="${url}" target="_blank">å‘½ä¸­ID=${r.item.id} åŒºæœ=${r.server} ä»·æ ¼=${r.item.price} å……å€¼=${r.extra.recharge} æœˆå¡=${r.extra.days} æµæ´¾=${r.extra.flow}</a>`;
        log(msg);
        if (autoOrderEl.checked) {
          try {
            const orderRes = await createOrder(r.item.id);
            if (orderRes.success) {
              const orderId = orderRes.result.id;
              const orderNumber = orderRes.result.orderNumber;
              const paymentUrl = getPaymentUrl(orderId);
              const paymentLink = `<a href="${paymentUrl}" target="_blank">ç‚¹å‡»å»ä»˜æ¬¾</a>`;
              log(`âœ” å·²è‡ªåŠ¨ä¸‹å• è®¢å•å·=${orderNumber} | ${paymentLink}`);
              showStatus(`è‡ªåŠ¨ä¸‹å•æˆåŠŸ ID=${r.item.id}`, 'success');
              await pushBark("è‡ªåŠ¨ä¸‹å•æˆåŠŸ", `ID=${r.item.id} è®¢å•å·:${orderNumber} | ç‚¹å‡»å»ä»˜æ¬¾`, paymentUrl);
            } else if (orderRes.scheduledTask) {
              log(`â° æ£€æµ‹åˆ°å…¬ç¤ºæœŸï¼Œå·²åˆ›å»ºå®šæ—¶ä»»åŠ¡ ID=${r.item.id}`);
              showStatus(`å·²åˆ›å»ºå®šæ—¶ä»»åŠ¡ ID=${r.item.id}`, 'warning');
            } else {
              log(`âœ˜ è‡ªåŠ¨ä¸‹å•å¤±è´¥: ${JSON.stringify(orderRes)}`);
            }
          } catch (e) {
            log("è‡ªåŠ¨ä¸‹å•å¼‚å¸¸: " + e.message);
          }
        } else {
          await pushBark("å‘ç°ç¬¦åˆæ¡ä»¶å•†å“", `ID=${r.item.id} åŒºæœ=${r.server} ä»·æ ¼=${r.item.price} å……å€¼=${r.extra.recharge} æœˆå¡=${r.extra.days} æµæ´¾=${r.extra.flow}`, url);
        }
      }
    }
    log(`æœ¬è½®å‘½ä¸­ ${matchCount} ä¸ª | ç´¯è®¡æ¨é€ ${seen.size} ä¸ª`);
    showStatus(`è¿è¡Œä¸­ - æœ¬è½®å‘½ä¸­ ${matchCount} ä¸ª`, 'success');
    const intervalSec = Number(intervalEl.value);
    if (intervalSec === 0) {
      log("è½®è¯¢é—´éš”=0ï¼Œç«‹å³å¼€å§‹ä¸‹ä¸€è½®...");
      setTimeout(check, 0);
    } else {
      const nextTime = new Date(Date.now() + intervalSec * 1000);
      log(`ä¸‹æ¬¡å¼€å§‹æ—¶é—´ï¼š${nextTime.toLocaleString()}`);
    }
  } catch (e) {
    log("é”™è¯¯: " + e.message);
    showStatus("æ£€æµ‹å‡ºé”™: " + e.message, 'error');
    if (running) {
      log("10 ç§’åç»§ç»­ç›‘å¬...");
      await delay(10000);
    }
  }
}
function startMonitor() {
  stopMonitor();
  running = true;
  const interval = Number(intervalEl.value) * 1000;
  log("å¼€å§‹ç›‘å¬...");
  showStatus("ç›‘å¬å·²å¯åŠ¨", 'success');
  loadToken();
  startTaskChecker();
  check();
  timer = setInterval(check, interval);
}
function stopMonitor() {
  running = false;
  if (timer) clearInterval(timer);
  timer = null;
  log("å·²åœæ­¢ç›‘å¬");
  showStatus("ç›‘å¬å·²åœæ­¢", 'warning');
}
function saveSettings() {
  const settings = {
    priceStart: priceStartEl.value,
    priceEnd: priceEndEl.value,
    cardDays: cardDaysEl.value,
    recharge: rechargeEl.value,
    flow: flowEl.value,
    bark: barkEl.value,
    barkJump: barkJumpEl.checked,
    interval: intervalEl.value,
    debug: debugEl.checked,
    username: usernameEl.value,
    password: passwordEl.value,
    autoOrder: autoOrderEl.checked,
    loginRetry: loginRetryEl.value,
    orderRetry: orderRetryEl.value,
    batchSize: batchSizeEl.value,
    selectedJobs: getCheckedJobs(),
    selectedEquips: getCheckedEquipments(),
    type: typeEl.value
  };
  localStorage.setItem("barkMonitorSettings", JSON.stringify(settings));
  log("è®¾ç½®å·²ä¿å­˜");
  showStatus("è®¾ç½®å·²ä¿å­˜", 'success');
}
function loadSettings() {
  const s = localStorage.getItem("barkMonitorSettings");
  if (!s) return;
  const settings = JSON.parse(s);
  priceStartEl.value = settings.priceStart;
  priceEndEl.value = settings.priceEnd;
  cardDaysEl.value = settings.cardDays;
  rechargeEl.value = settings.recharge || 0;
  flowEl.value = settings.flow || "";
  barkEl.value = settings.bark;
  barkJumpEl.checked = settings.barkJump;
  intervalEl.value = settings.interval;
  debugEl.checked = settings.debug || false;
  usernameEl.value = settings.username || "";
  passwordEl.value = settings.password || "";
  autoOrderEl.checked = settings.autoOrder || false;
  loginRetryEl.value = settings.loginRetry || 3;
  orderRetryEl.value = settings.orderRetry || 3;
  batchSizeEl.value = settings.batchSize || 5;
  if (settings.type) {
    typeEl.value = settings.type;
  }
  if (settings.selectedJobs) {
    const jobs = settings.selectedJobs.split(',');
    document.querySelectorAll('.job-checkbox').forEach(cb => {
      cb.checked = jobs.includes(cb.value);
    });
  }
  if (settings.selectedEquips) {
    const equips = settings.selectedEquips.split(',');
    document.querySelectorAll('.equip-checkbox').forEach(cb => {
      cb.checked = equips.includes(cb.value);
    });
  }
  log("å·²åŠ è½½ä¿å­˜çš„è®¾ç½®");
}
const typeEl = document.getElementById("type");
const priceStartEl = document.getElementById("priceStart");
const priceEndEl = document.getElementById("priceEnd");
const cardDaysEl = document.getElementById("cardDays");
const rechargeEl = document.getElementById("recharge");
const flowEl = document.getElementById("flow");
const barkEl = document.getElementById("bark");
const barkJumpEl = document.getElementById("barkJump");
const intervalEl = document.getElementById("interval");
const autoOrderEl = document.getElementById("autoOrder");
const usernameEl = document.getElementById("username");
const passwordEl = document.getElementById("password");
const manualGoodsIdEl = document.getElementById("manualGoodsId");
const debugEl = document.getElementById("debug");
const batchSizeEl = document.getElementById("batchSize");
const loginRetryEl = document.getElementById("loginRetry");
const orderRetryEl = document.getElementById("orderRetry");
loadSettings();
onTypeChange();
window.addEventListener('load', () => {
  loadToken();
  loadScheduledTasks();
  startTaskChecker();
});
window.addEventListener('beforeunload', () => {
  if (running) {
    saveSettings();
  }
  stopTaskChecker();
});
  </script>

  <!--  (ä¿®æ­£å…¬å¼ä¸‰è®¡ç®—) -->
  <script>
  (function() {
    const API_LIST = 'https://api.52108.com/api/services/cbg/Goods/GetIndexGoodsPaged';
    const API_ROLE = 'https://api.52108.com/api/services/app/GameRoleInfo/GetGameRoleInfo';
    const SETTINGS_KEY = 'val_valueFilterSettings';
    const WORTH_KEY = 'val_worthListData';
    let running = false;
    let worthList = [];
    let timer = null;
    
    function log(msg) {
      const el = document.getElementById('val_log');
      const ts = new Date().toLocaleTimeString();
      el.innerHTML += `[${ts}] ${msg}<br>`;
      el.scrollTop = el.scrollHeight;
    }
    
    function showStatus(msg, type = 'success') {
      const bar = document.getElementById('val_statusBar');
      bar.textContent = msg;
      bar.className = `status-bar ${type}`;
      bar.classList.remove('hidden');
    }
    
    function getJobList() {
      return Array.from(document.querySelectorAll('.val-job-cb:checked')).map(cb => cb.value).join(',');
    }
    
    function getFormulaType() {
      if (document.getElementById('val_formula3').checked) return '3';
      if (document.getElementById('val_formula2').checked) return '2';
      return '1';
    }
    
    function getThreshold() {
      const v = document.getElementById('val_threshold').value.trim();
      if (v === '') return 0;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    
    function saveSettings() {
      const settings = {
        selectedJobs: getJobList(),
        onlyPresale: document.getElementById('val_onlyPresale').checked,
        debug: document.getElementById('val_debug').checked,
        flow: document.getElementById('val_flow').value,
        recharge: document.getElementById('val_recharge').value,
        cardDays: document.getElementById('val_cardDays').value,
        batchSize: document.getElementById('val_batchSize').value,
        formulaType: getFormulaType(),
        threshold: document.getElementById('val_threshold').value.trim()
      };
      try {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        log('è®¾ç½®å·²ä¿å­˜');
        showStatus('è®¾ç½®å·²ä¿å­˜', 'success');
      } catch (e) {
        log('ä¿å­˜è®¾ç½®å¤±è´¥: ' + e.message);
        showStatus('ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
      }
    }
    
    function loadSettings() {
      try {
        const s = localStorage.getItem(SETTINGS_KEY);
        if (!s) return;
        const settings = JSON.parse(s);
        document.getElementById('val_onlyPresale').checked = !!settings.onlyPresale;
        document.getElementById('val_debug').checked = !!settings.debug;
        if (settings.flow != null) document.getElementById('val_flow').value = settings.flow;
        if (settings.recharge != null) document.getElementById('val_recharge').value = settings.recharge;
        if (settings.cardDays != null) document.getElementById('val_cardDays').value = settings.cardDays;
        if (settings.batchSize != null) document.getElementById('val_batchSize').value = settings.batchSize;
        if (settings.threshold !== undefined && settings.threshold !== '') {
          document.getElementById('val_threshold').value = settings.threshold;
        }
        if (settings.formulaType === '3') document.getElementById('val_formula3').checked = true;
        else if (settings.formulaType === '2') document.getElementById('val_formula2').checked = true;
        else document.getElementById('val_formula1').checked = true;
        if (settings.selectedJobs) {
          const jobs = settings.selectedJobs.split(',').filter(Boolean);
          document.querySelectorAll('.val-job-cb').forEach(cb => {
            cb.checked = jobs.includes(cb.value);
          });
        }
        log('å·²åŠ è½½ä¿å­˜çš„è®¾ç½®');
      } catch (e) {
        log('åŠ è½½è®¾ç½®å¤±è´¥: ' + (e.message || e));
      }
    }
    
    function buildListUrl(skip, maxCount) {
      const t = Date.now();
      const jobList = getJobList();
      // ä»·æ ¼åŒºé—´æ”¹ä¸ºè·Ÿéšä¸»é¡µçš„â€œæœ€ä½ä»·æ ¼ / æœ€é«˜ä»·æ ¼â€è®¾ç½®
      const priceStartInput = document.getElementById('priceStart');
      const priceEndInput = document.getElementById('priceEnd');
      const priceStart = priceStartInput && priceStartInput.value !== '' ? Number(priceStartInput.value) : 1;
      const priceEnd = priceEndInput && priceEndInput.value !== '' ? Number(priceEndInput.value) : 999999;

      let url = `${API_LIST}?GameServerId=&TypeList=&PriceStart=${priceStart}&PriceEnd=${priceEnd}&EquipmentTypeList=&Id=&Name=&Sorting=&SkipCount=${skip}&MaxResultCount=${maxCount}&OnlyPlayed=false&time=${t}&type=99`;
      if (jobList) url += '&RoleJobList=' + encodeURIComponent(jobList);
      return url;
    }
    
    async function fetchTotalCount() {
      const res = await fetch(buildListUrl(0, 1));
      const data = await res.json();
      return data?.result?.totalCount ?? 0;
    }
    
    async function fetchAllItems(totalCount) {
      const res = await fetch(buildListUrl(0, totalCount));
      const data = await res.json();
      return data?.result?.items ?? [];
    }
    
    function parseRoleDetail(html) {
      const numFromVal = (key) => {
        const m = html.match(new RegExp(`${key}ï¼š.*?val'>(.*?)<`));
        if (!m || !m[1]) return null;
        const s = m[1].replace(/å…ƒå®|,/g, '').trim();
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      };
      const market = numFromVal('å•†è¡Œå‰©ä½™é¢åº¦');
      const escort = numFromVal('æŠ¼é•–å‰©ä½™è¿”åˆ©');
      const cardMatch = html.match(/æœˆå¡åˆ°æœŸæ—¶é—´ï¼š.*?val'>(.*?)</);
      const cardExpireText = cardMatch ? cardMatch[1].trim() : '';
      const hasCard = !!cardExpireText && cardExpireText !== 'æ— æœˆå¡';
      const flowMatch = html.match(/æµæ´¾ï¼š.*?val'>(.*?)</);
      const flow = flowMatch ? flowMatch[1].trim() : '';
      const rechargeMatch = html.match(/å……å€¼ï¼š.*?val'>(\d+)/);
      const recharge = rechargeMatch ? parseInt(rechargeMatch[1], 10) : 0;
      let cardDays = 0;
      if (hasCard) {
        const expire = new Date(cardExpireText).getTime();
        if (Number.isFinite(expire)) {
          cardDays = Math.max(0, Math.floor((expire - Date.now()) / 86400000));
        }
      }
      return { market, escort, hasCard, flow, recharge, cardDays };
    }
    
    function parseFlows(text) {
      if (!text) return [];
      return text.split(/[\s,ï¼Œã€]+/).map(s => s.trim()).filter(Boolean);
    }
    
    function matchFlow(target, flows) {
      if (!flows.length) return true;
      return flows.some(f => target.includes(f));
    }
    
    // ä¿®æ­£å…¬å¼ä¸‰è®¡ç®—å‡½æ•°
    function calcValue(market, escort, hasCard) {
      const formula = getFormulaType();
      let base = 0;
      
      if (formula === '2') {
        // å…¬å¼äºŒï¼šåªçœ‹å•†è¡Œ
        base = market != null ? market / 300 : 0;
      } else if (formula === '3') {
        // å…¬å¼ä¸‰ï¼šå•†è¡Œå…¨é¢ + æŠ¼é•–æ‰“66æŠ˜
        const marketPart = market != null ? market / 300 : 0;
        const escortPart = escort != null ? (escort / 300) * 0.66 : 0;
        base = marketPart + escortPart;
      } else {
        // å…¬å¼ä¸€ï¼šå•†è¡Œ + æŠ¼é•–å…¨é¢
        base = ((market != null ? market : 0) + (escort != null ? escort : 0)) / 300;
      }
      
      return hasCard ? base : (base - 30);
    }
    
    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function renderWorthList() {
      const el = document.getElementById('val_worthList');
      if (!el) return;
      if (!worthList.length) {
        el.innerHTML = '<div class="no-matched">æš‚æ— ï¼Œæ»¡è¶³ä»·å€¼å…¬å¼çš„å•†å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>';
        return;
      }
      const threshold = getThreshold();
      const thresholdStr = threshold === 0 ? '' : (threshold > 0 ? `+${threshold}` : String(threshold));
      const formulaType = getFormulaType();
      
      el.innerHTML = worthList.map(w => {
        const url = `http://dms.52108.com/#/pages/shop/detail?id=${w.id}`;
        const rawValue = calcValue(w.market, w.escort, w.hasCard);
        const value = rawValue + threshold;
        const earn = Math.max(0, value - w.price);
        
        // æ·»åŠ è¯¦ç»†è®¡ç®—è¿‡ç¨‹
        let calcDetail = '';
        if (formulaType === '3') {
          const marketPart = w.market != null ? w.market / 300 : 0;
          const escortPart = w.escort != null ? (w.escort / 300) * 0.66 : 0;
          calcDetail = `(å•†è¡Œ${w.market}/300=${marketPart.toFixed(1)} + æŠ¼é•–${w.escort}/300Ã—0.66=${escortPart.toFixed(1)})`;
          if (!w.hasCard) calcDetail += ' - 30';
          calcDetail += ` = ${rawValue.toFixed(1)}`;
        } else if (formulaType === '2') {
          calcDetail = `å•†è¡Œ${w.market}/300=${rawValue.toFixed(1)}`;
        } else {
          calcDetail = `(å•†è¡Œ${w.market}+æŠ¼é•–${w.escort})/300=${rawValue.toFixed(1)}`;
        }
        
        const valueDisplay = thresholdStr
          ? `ä»·å€¼â‰ˆ${rawValue.toFixed(1)}${thresholdStr}=${value.toFixed(1)}`
          : `ä»·å€¼â‰ˆ${value.toFixed(1)}`;

        const hasNotice = w.noticeEndTime || w.noticeEndTimeStr;
        const noticeText = hasNotice
          ? `${escapeHtml(w.noticeEndTimeStr || '')}ï¼ˆæœ¬åœ°ï¼š${w.noticeEndTime ? new Date(w.noticeEndTime).toLocaleString() : 'æœªçŸ¥'}ï¼‰`
          : 'æ— ';

        // æ˜¯å¦é¢„å”®ï¼šæœ‰å…¬ç¤ºç»“æŸæ—¶é—´ä¸”æ™šäºå½“å‰æ—¶é—´
        const isPresale = !!(w.noticeEndTime && w.noticeEndTime > Date.now());
        const primaryBtnHtml = isPresale
          ? `<button 
              type="button"
              onclick="valAddToSchedule(${w.id})"
              style="padding:4px 8px; background:#28a745; color:#fff; border:none; border-radius:4px; font-size:12px; cursor:pointer;"
            >
              æ·»åŠ å®šæ—¶ä»»åŠ¡
            </button>`
          : `<button 
              type="button"
              onclick="oneClickOrder(${w.id})"
              style="padding:4px 8px; background:#ff6a00; color:#fff; border:none; border-radius:4px; font-size:12px; cursor:pointer;"
            >
              ä¸€é”®ä¸‹å•
            </button>`;
        
        return `<div class="matched-item">
          <div class="worth-earn">èƒ½èµšçº¦ ${earn.toFixed(1)} å…ƒ</div>
          <div class="matched-name"><a href="${url}" target="_blank">${escapeHtml(w.name)}</a></div>
          <span class="matched-meta">ID: <a href="${url}" target="_blank">${w.id}</a></span>
          <span class="matched-meta">åŒºæœ: ${escapeHtml(w.server)}</span>
          <span class="matched-meta">å”®ä»·: ${w.price} å…ƒ</span>
          <span class="matched-meta">å•†è¡Œ: ${w.market}</span>
          <span class="matched-meta">æŠ¼é•–: ${w.escort}</span>
          <span class="matched-meta">${w.hasCard ? 'æœ‰æœˆå¡' : 'æ— æœˆå¡'}</span>
          <span class="matched-meta">æµæ´¾: ${escapeHtml(w.flow)}</span>
          <span class="matched-meta">å……å€¼: ${w.recharge}</span>
          <span class="matched-meta">å…¬ç¤ºç»“æŸ: ${noticeText}</span>
          <span class="matched-meta">${valueDisplay} &gt; å”®ä»· ${w.price} âœ“</span>
          <span class="matched-meta" style="color: #888; font-size: 11px;">${calcDetail}</span>
          <div style="margin-left:auto; display:flex; gap:6px;">
            ${primaryBtnHtml}
            <button 
              type="button"
              onclick="valRemoveWorthItem(${w.id})"
              style="padding:4px 8px; background:#dc3545; color:#fff; border:none; border-radius:4px; font-size:12px; cursor:pointer;"
            >
              åˆ é™¤
            </button>
          </div>
        </div>`;
      }).join('');
    }

    function saveWorthList() {
      try {
        localStorage.setItem(WORTH_KEY, JSON.stringify(worthList));
      } catch (e) {
        log('ä¿å­˜å€¼å¾—åˆ—è¡¨å¤±è´¥: ' + (e.message || e));
      }
    }

    function loadWorthList() {
      try {
        const s = localStorage.getItem(WORTH_KEY);
        if (!s) return;
        const data = JSON.parse(s);
        if (Array.isArray(data)) {
          worthList = data;
          renderWorthList();
          log(`å·²ä»æœ¬åœ°åŠ è½½ ${worthList.length} æ¡å€¼å¾—è®°å½•`);
        }
      } catch (e) {
        log('åŠ è½½å€¼å¾—åˆ—è¡¨å¤±è´¥: ' + (e.message || e));
      }
    }

    function clearWorthList() {
      worthList = [];
      saveWorthList();
      renderWorthList();
      log('å·²æ¸…ç©ºå€¼å¾—åˆ—è¡¨');
    }

    function removeWorthItem(id) {
      const before = worthList.length;
      worthList = worthList.filter(w => String(w.id) !== String(id));
      if (worthList.length !== before) {
        saveWorthList();
        renderWorthList();
        log(`å·²ä»å€¼å¾—åˆ—è¡¨ç§»é™¤ ID=${id}`);
      }
    }
    
    async function getRoleDetail(goodsId) {
      try {
        const res = await fetch(`${API_ROLE}?GoodsId=${goodsId}`);
        const data = await res.json();
        if (data?.result?.[0]?.data) {
          return parseRoleDetail(data.result[0].data);
        }
      } catch (e) {
        log(`è·å–è¯¦æƒ…å¤±è´¥ ID=${goodsId}: ${e.message}`);
      }
      return null;
    }
    
    async function run() {
      const batchSize = Math.max(1, parseInt(document.getElementById('val_batchSize').value, 10) || 5);
      const needFlow = parseFlows(document.getElementById('val_flow').value.trim());
      const needRecharge = parseInt(document.getElementById('val_recharge').value, 10) || 0;
      const needCardDays = parseInt(document.getElementById('val_cardDays').value, 10) || 0;
      const onlyPresale = document.getElementById('val_onlyPresale').checked;
      const threshold = getThreshold();
      const debug = document.getElementById('val_debug').checked;
      
      log('è·å– totalCount...');
      let total = 0;
      try {
        total = await fetchTotalCount();
      } catch (e) {
        log('è·å–æ€»æ•°å¤±è´¥: ' + e.message);
        showStatus('è·å–æ€»æ•°å¤±è´¥', 'error');
        return;
      }
      log('å½“å‰ç­›é€‰æ€»æ•°: ' + total);
      if (total === 0) {
        showStatus('æ— å•†å“', 'warning');
        return;
      }
      
      log('æ‹‰å–å…¨éƒ¨åˆ—è¡¨ï¼ˆID + å”®ä»·ï¼‰...');
      let items = [];
      try {
        items = await fetchAllItems(total);
      } catch (e) {
        log('æ‹‰å–åˆ—è¡¨å¤±è´¥: ' + e.message);
        return;
      }
      
      if (onlyPresale) {
        const now = Date.now();
        const before = items.length;
        items = items.filter(it => {
          const end = it.noticeEndTime ? new Date(it.noticeEndTime).getTime() : 0;
          const keep = end > now;
          if (debug && !keep) {
            log(`é¢„å”®ç­›æ‰ ID=${it.id || 'æœªçŸ¥'}: noticeEndTime=${it.noticeEndTime || 'æ— '}`);
          }
          return keep;
        });
        log(`ä»…é¢„å”®ç­›é€‰åå‰©ä½™ ${items.length} æ¡ï¼ˆåŸå§‹ ${before} æ¡ï¼‰`);
      }
      
      log(`å…± ${items.length} ä¸ªå•†å“ï¼Œå¼€å§‹å¹¶å‘è¯¦æƒ…æ£€æµ‹ï¼ˆ${batchSize}ä¸ª/æ‰¹ï¼‰...`);
      showStatus(`æ­£åœ¨æ£€æµ‹ ${items.length} ä¸ªå•†å“...`, 'processing');
      
      let checkedCount = 0;
      for (let i = 0; i < items.length; i += batchSize) {
        if (!running) break;
        const batch = items.slice(i, i + batchSize);
        const tasks = batch.map(async (item) => {
          const t0 = Date.now();
          const detail = await getRoleDetail(item.id);
          const cost = Date.now() - t0;
          if (!detail) {
            if (debug) log(`è¿‡æ»¤ ID=${item.id}: è·å–è¯¦æƒ…å¤±è´¥`);
            return;
          }
          const server = item.gameServer?.subName || 'æœªçŸ¥åŒºæœ';
          const okRecharge = detail.recharge >= needRecharge;
          const okDays = detail.cardDays >= needCardDays;
          const okFlow = matchFlow(detail.flow, needFlow);

          if (debug) {
            log(
              `æ£€æµ‹ID=${item.id} | åŒºæœ=${server} | ä»·æ ¼=${item.price} | å……å€¼=${detail.recharge}${okRecharge ? 'âœ”' : 'âœ˜'} | æœˆå¡=${detail.cardDays}${okDays ? 'âœ”' : 'âœ˜'} | æµæ´¾=${detail.flow || 'æ— '}${okFlow ? 'âœ”' : 'âœ˜'} | è€—æ—¶=${cost}ms`
            );
          }

          if (!okRecharge) {
            if (debug && needRecharge > 0) {
              log(`è¿‡æ»¤ ID=${item.id}: å……å€¼ ${detail.recharge} < è¦æ±‚ ${needRecharge}`);
            }
            return;
          }
          if (!okDays) {
            if (debug && needCardDays > 0) {
              log(`è¿‡æ»¤ ID=${item.id}: æœˆå¡å¤©æ•° ${detail.cardDays} < è¦æ±‚ ${needCardDays}`);
            }
            return;
          }
          if (!okFlow) {
            if (debug && needFlow.length > 0) {
              log(`è¿‡æ»¤ ID=${item.id}: æµæ´¾ "${detail.flow}" ä¸åœ¨ ${JSON.stringify(needFlow)}`);
            }
            return;
          }
          
          const val = calcValue(detail.market, detail.escort, detail.hasCard);
          if ((val + threshold) > item.price) {
            const hit = {
              id: item.id,
              name: item.name || `å•†å“${item.id}`,
              server: item.gameServer?.subName || 'æœªçŸ¥',
              price: item.price,
              market: detail.market,
              escort: detail.escort,
              hasCard: detail.hasCard,
              flow: detail.flow,
              recharge: detail.recharge,
              days: detail.cardDays,
              noticeEndTime: item.noticeEndTime ? new Date(item.noticeEndTime).getTime() : null,
              noticeEndTimeStr: item.noticeEndTime || ''
            };
            if (!worthList.some(w => w.id === hit.id)) {
              worthList.unshift(hit);
              renderWorthList();
              saveWorthList();
              log(`å‘½ä¸­ ID=${hit.id} èµš${(val + threshold - item.price).toFixed(1)}`);
            }
          } else if (debug) {
            const earn = (val + threshold - item.price).toFixed(1);
            log(`è¿‡æ»¤ ID=${item.id}: ä»·å€¼ä¸å¤Ÿ value=${(val + threshold).toFixed(1)} å”®ä»·=${item.price} (å·®å€¼=${earn})`);
          }
        });
        await Promise.all(tasks);
        checkedCount += batch.length;
        if (checkedCount % 20 === 0) {
          showStatus(`è¿›åº¦: ${checkedCount}/${items.length}`, 'processing');
        }
      }
      
      if (running) {
        log('æœ¬è½®ç»“æŸã€‚');
        showStatus('æœ¬è½®ç»“æŸ', 'success');
        document.getElementById('val_btnStart').disabled = false;
        document.getElementById('val_btnStop').disabled = true;
        running = false;
      }
    }
    
    document.getElementById('val_btnSave').onclick = saveSettings;
    document.getElementById('val_btnStart').onclick = () => {
      if (running) return;
      running = true;
      document.getElementById('val_btnStart').disabled = true;
      document.getElementById('val_btnStop').disabled = false;
      worthList = [];
      renderWorthList();
      saveWorthList();
      log('å¼€å§‹è¿è¡Œ...');
      run().finally(() => {
        running = false;
        document.getElementById('val_btnStart').disabled = false;
        document.getElementById('val_btnStop').disabled = true;
      });
    };
    document.getElementById('val_btnStop').onclick = () => {
      if (!running) return;
      running = false;
      log('æ­£åœ¨åœæ­¢...');
      showStatus('æ­£åœ¨åœæ­¢...', 'warning');
    };
    loadSettings();
    loadWorthList();

    // æš´éœ²ç»™å¤–éƒ¨æŒ‰é’®ä½¿ç”¨
    window.valClearWorthList = clearWorthList;
    window.valRemoveWorthItem = removeWorthItem;
    window.valAddToSchedule = function(id) {
      if (typeof window.createScheduledTask !== 'function') {
        log('å½“å‰é¡µé¢æœªåŠ è½½å®šæ—¶ä¸‹å•åŠŸèƒ½ï¼Œæ— æ³•æ·»åŠ ä»»åŠ¡');
        return;
      }
      const item = worthList.find(w => String(w.id) === String(id));
      if (!item) {
        log(`æœªåœ¨å€¼å¾—åˆ—è¡¨ä¸­æ‰¾åˆ° ID=${id}ï¼Œæ— æ³•æ·»åŠ å®šæ—¶ä»»åŠ¡`);
        return;
      }
      log(`å‡†å¤‡å°†å€¼å¾—å•†å“ ID=${id} æ·»åŠ åˆ°å®šæ—¶ä¸‹å•ä»»åŠ¡åˆ—è¡¨...`);
      window.createScheduledTask(id).then(() => {
        log(`âœ” å·²å°† ID=${id} æ·»åŠ åˆ°å®šæ—¶ä¸‹å•ä»»åŠ¡åˆ—è¡¨`);
      }).catch(e => {
        log(`âœ˜ æ·»åŠ å®šæ—¶ä»»åŠ¡å¤±è´¥ ID=${id}: ${e.message || e}`);
      });
    };
  })();
  </script>
</body>
</html>
